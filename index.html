<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gaze Tracker</title>
  /* WebGazer.js library */
  <script src="webgazer.js" type="text/javascript" ></script>
  <style>
    body { font-family: sans-serif; margin: 0; background: #f5f5f5; }

    #timer {
      position: fixed;
      top: 20px; right: 20px;
      font-size: 36px;
      font-weight: bold;
      background: #fff;
      padding: 10px 18px;
      border: 2px solid #333;
      border-radius: 8px;
    }

    #text-area {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 480px;
      background: #fff;
      border: 2px solid #333;
      border-radius: 8px;
      padding: 30px;
      font-size: 17px;
      line-height: 1.7;
      text-align: center;
    }

    #stats {
      position: fixed;
      bottom: 20px; left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 2px solid #333;
      border-radius: 8px;
      padding: 14px 28px;
      font-size: 16px;
      text-align: center;
    }

    #start-btn {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      padding: 14px 32px;
      font-size: 18px;
      cursor: pointer;
      z-index: 999;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 6px;
    }

    .looking { border-color: #e74c3c !important; background: #fff0f0 !important; }
  </style>
</head>
<body>

  <div id="timer">00:00</div>
  <div id="text-area">Read this text. Try not to check the timer too often. How many times will you glance at it?</div>
  <div id="stats">Toggles: <b id="toggle-count">0</b> &nbsp;|&nbsp; Timer glances: <b id="timer-glances">0</b> &nbsp;|&nbsp; Currently looking at: <b id="current-zone">—</b></div>
  <button id="start-btn" onclick="startTracking()">Start Eye Tracking</button>

<script>
  let toggleCount = 0;
  let timerGlances = 0;
  let currentZone = null;
  let frameBuffer = [];
  const THRESHOLD = 6;
  let elapsed = 0;

  function getZone(x, y) {
    const timerRect = document.getElementById('timer').getBoundingClientRect();
    const textRect  = document.getElementById('text-area').getBoundingClientRect();
    if (x >= timerRect.left && x <= timerRect.right && y >= timerRect.top && y <= timerRect.bottom) return 'timer';
    if (x >= textRect.left  && x <= textRect.right  && y >= textRect.top  && y <= textRect.bottom)  return 'text';
    return null;
  }

  function setZone(zone) {
    if (zone === currentZone) return;
    const prev = currentZone;
    currentZone = zone;

    // highlight active element
    document.getElementById('timer').classList.toggle('looking', zone === 'timer');
    document.getElementById('text-area').classList.toggle('looking', zone === 'text');

    if (zone === 'timer') timerGlances++;
    if ((prev === 'timer' && zone === 'text') || (prev === 'text' && zone === 'timer')) toggleCount++;

    document.getElementById('toggle-count').textContent = toggleCount;
    document.getElementById('timer-glances').textContent = timerGlances;
    document.getElementById('current-zone').textContent = zone === 'timer' ? 'Timer' : zone === 'text' ? 'Text' : '—';
  }

  function startTracking() {
    document.getElementById('start-btn').remove();

    webgazer.setGazeListener(function(data) {
      if (!data) return;
      frameBuffer.push(getZone(data.x, data.y));
      if (frameBuffer.length > THRESHOLD) frameBuffer.shift();
      // use majority vote over buffer
      const counts = {};
      frameBuffer.forEach(z => counts[z] = (counts[z] || 0) + 1);
      const dominant = Object.entries(counts).sort((a,b) => b[1]-a[1])[0][0];
      setZone(dominant === 'null' ? null : dominant);
    }).begin();

    // start timer
    setInterval(() => {
      elapsed++;
      const m = String(Math.floor(elapsed/60)).padStart(2,'0');
      const s = String(elapsed%60).padStart(2,'0');
      document.getElementById('timer').textContent = `${m}:${s}`;
    }, 1000);
  }
</script>
</body>
</html>

