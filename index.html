<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>WebGazer Attention Switch Demo</title>

  <!-- WebGazer CDN -->
  <script src="https://cdn.jsdelivr.net/npm/webgazer/dist/webgazer.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      height: 100vh;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #timer {
      position: fixed;
      top: 20px;
      right: 20px;
      font-size: 40px;
      background: lightgray;
      padding: 20px 30px;
      border-radius: 12px;
    }

    #centerText {
      font-size: 32px;
      text-align: center;
      width: 50%;
    }

    #results {
      position: fixed;
      bottom: 20px;
      left: 20px;
      font-size: 22px;
    }

    .calibration-dot {
      width: 25px;
      height: 25px;
      background: red;
      border-radius: 50%;
      position: fixed;
      cursor: pointer;
    }
  </style>
</head>

<body>

<div id="timer">60</div>

<div id="centerText">
  Focus on this text in the middle of the screen.
</div>

<div id="results">
  Switch Count: 0
</div>

<script>
  // Fix MediaPipe path for Vercel
  webgazer.params.faceMeshBasePath =
    "https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/";

  webgazer.setRegression('ridge');

  const timerElement = document.getElementById("timer");
  const centerText = document.getElementById("centerText");
  const results = document.getElementById("results");

  let timeLeft = 60;
  let switchCount = 0;
  let trackingActive = false;

  let currentRegion = null;
  let stableRegion = null;
  let regionStartTime = 0;
  const STABILITY_TIME = 300;

  function startTimer() {
    const countdown = setInterval(() => {
      timeLeft--;
      timerElement.innerText = timeLeft;

      if (timeLeft <= 0) {
        clearInterval(countdown);
        trackingActive = false;
        webgazer.end();
        alert("Time's up!\nTotal switches: " + switchCount);
      }
    }, 1000);
  }

  function getRegion(x, y) {
    const timerRect = timerElement.getBoundingClientRect();
    const textRect = centerText.getBoundingClientRect();

    if (
      x >= timerRect.left &&
      x <= timerRect.right &&
      y >= timerRect.top &&
      y <= timerRect.bottom
    ) return "timer";

    if (
      x >= textRect.left &&
      x <= textRect.right &&
      y >= textRect.top &&
      y <= textRect.bottom
    ) return "text";

    return "other";
  }

  function startTracking() {

    webgazer.setGazeListener(function(data) {
      if (!trackingActive || data == null) return;

      const region = getRegion(data.x, data.y);
      if (region === "other") return;

      const now = Date.now();

      if (region !== currentRegion) {
        currentRegion = region;
        regionStartTime = now;
      }

      if (region === currentRegion && now - regionStartTime > STABILITY_TIME) {
        if (stableRegion !== region) {
          if (stableRegion !== null) {
            switchCount++;
            results.innerText = "Switch Count: " + switchCount;
          }
          stableRegion = region;
        }
      }

    }).begin();

    webgazer.showVideo(false);
    webgazer.showPredictionPoints(true);

    trackingActive = true;
    startTimer();
  }

  const calibrationPoints = [
    { x: "10%", y: "10%" },
    { x: "50%", y: "10%" },
    { x: "90%", y: "10%" },
    { x: "10%", y: "50%" },
    { x: "50%", y: "50%" },
    { x: "90%", y: "50%" },
    { x: "10%", y: "90%" },
    { x: "50%", y: "90%" },
    { x: "90%", y: "90%" }
  ];

  let calibrationClicks = {};
  let calibrationComplete = false;

  function createCalibration() {
    alert("Calibration starting.\nLook at each red dot and click it 5 times.");

    calibrationPoints.forEach((point, index) => {
      const dot = document.createElement("div");
      dot.className = "calibration-dot";
      dot.style.left = point.x;
      dot.style.top = point.y;
      dot.style.transform = "translate(-50%, -50%)";

      calibrationClicks[index] = 0;

      dot.addEventListener("click", function () {
        calibrationClicks[index]++;
        dot.style.opacity = 1 - calibrationClicks[index] * 0.15;

        if (calibrationClicks[index] >= 5) {
          dot.remove();
        }

        checkCalibrationComplete();
      });

      document.body.appendChild(dot);
    });
  }

  function checkCalibrationComplete() {
    const allDone = Object.values(calibrationClicks).every(c => c >= 5);
    if (allDone && !calibrationComplete) {
      calibrationComplete = true;
      alert("Calibration complete! Tracking begins.");
      startTracking();
    }
  }

  window.onload = function () {
    createCalibration();
  };
</script>

</body>
</html>