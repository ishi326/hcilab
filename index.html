<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Eye Tracking — Gaze Toggle Demo</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/webgazer/2.0.1/webgazer.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&display=swap');

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0d0d0f;
      --surface: #141418;
      --border: #2a2a30;
      --text: #e8e6df;
      --muted: #6b6b72;
      --accent: #e8c96e;
      --accent2: #6ec2e8;
      --timer-zone: rgba(232, 201, 110, 0.07);
      --text-zone: rgba(110, 194, 232, 0.07);
      --toggle-flash: #e87b6e;
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: 'Space Mono', monospace;
      overflow: hidden;
    }

    /* ─── ZONES ─────────────────────────────────── */
    #zone-timer {
      position: fixed;
      top: 16px; right: 16px;
      width: 220px; height: 110px;
      border: 1px solid color-mix(in srgb, var(--accent) 25%, transparent);
      border-radius: 10px;
      background: var(--timer-zone);
      pointer-events: none;
      transition: border-color 0.2s, background 0.2s;
      z-index: 0;
    }
    #zone-timer.active {
      border-color: var(--accent);
      background: color-mix(in srgb, var(--accent) 14%, transparent);
      box-shadow: 0 0 24px color-mix(in srgb, var(--accent) 30%, transparent);
    }

    #zone-text {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 540px; height: 240px;
      border: 1px solid color-mix(in srgb, var(--accent2) 20%, transparent);
      border-radius: 10px;
      background: var(--text-zone);
      pointer-events: none;
      transition: border-color 0.2s, background 0.2s;
      z-index: 0;
    }
    #zone-text.active {
      border-color: var(--accent2);
      background: color-mix(in srgb, var(--accent2) 14%, transparent);
      box-shadow: 0 0 24px color-mix(in srgb, var(--accent2) 30%, transparent);
    }

    /* ─── TIMER ─────────────────────────────────── */
    #timer-widget {
      position: fixed;
      top: 28px; right: 28px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
      z-index: 10;
    }
    #timer-label {
      font-size: 10px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--accent);
      opacity: 0.7;
    }
    #timer-display {
      font-size: 38px;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 0.04em;
      text-shadow: 0 0 20px color-mix(in srgb, var(--accent) 50%, transparent);
      line-height: 1;
    }

    /* ─── MAIN TEXT ──────────────────────────────── */
    #main-text {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 500px;
      text-align: center;
      z-index: 10;
    }
    #main-text h1 {
      font-family: 'Libre Baskerville', serif;
      font-size: 26px;
      font-weight: 700;
      font-style: italic;
      color: var(--accent2);
      line-height: 1.35;
      margin-bottom: 14px;
      text-shadow: 0 0 20px color-mix(in srgb, var(--accent2) 40%, transparent);
    }
    #main-text p {
      font-size: 12.5px;
      color: var(--muted);
      line-height: 1.75;
      letter-spacing: 0.03em;
    }

    /* ─── STATS PANEL ───────────────────────────── */
    #stats {
      position: fixed;
      bottom: 28px; left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 2px;
      z-index: 10;
    }
    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px 22px;
      text-align: center;
      min-width: 130px;
    }
    .stat-val {
      font-size: 28px;
      font-weight: 700;
      line-height: 1;
      margin-bottom: 4px;
    }
    .stat-label {
      font-size: 9px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--muted);
    }
    #stat-toggles .stat-val { color: var(--toggle-flash); }
    #stat-timer-looks .stat-val { color: var(--accent); }
    #stat-text-looks .stat-val { color: var(--accent2); }
    #stat-current .stat-val { color: var(--text); font-size: 13px; letter-spacing: 0.05em; }

    /* toggle flash animation */
    @keyframes toggleFlash {
      0%   { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    .flash { animation: toggleFlash 0.25s ease-out; }

    /* ─── CALIBRATION OVERLAY ───────────────────── */
    #calibration-overlay {
      position: fixed; inset: 0;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      z-index: 1000;
    }
    #calibration-overlay h2 {
      font-family: 'Libre Baskerville', serif;
      font-size: 22px;
      font-style: italic;
      color: var(--text);
    }
    #calibration-overlay p {
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 0.06em;
      max-width: 420px;
      text-align: center;
      line-height: 1.7;
    }
    #start-btn {
      margin-top: 10px;
      padding: 12px 36px;
      background: transparent;
      border: 1px solid var(--accent);
      color: var(--accent);
      font-family: 'Space Mono', monospace;
      font-size: 12px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s, color 0.2s;
    }
    #start-btn:hover {
      background: var(--accent);
      color: var(--bg);
    }
    #status-msg {
      font-size: 10px;
      color: var(--muted);
      letter-spacing: 0.08em;
      min-height: 18px;
    }

    /* ─── GAZE DOT ──────────────────────────────── */
    #gaze-dot {
      position: fixed;
      width: 14px; height: 14px;
      border-radius: 50%;
      background: rgba(255,255,255,0.5);
      border: 2px solid white;
      pointer-events: none;
      transform: translate(-50%, -50%);
      z-index: 9999;
      transition: background 0.15s;
      display: none;
    }

    /* hide webgazer video feed by default, keep it top-left small */
    #webgazerVideoContainer {
      opacity: 0.4 !important;
      width: 120px !important;
      height: 90px !important;
    }
    #webgazerFaceOverlay, #webgazerFaceFeedbackBox {
      width: 120px !important;
      height: 90px !important;
    }
  </style>
</head>
<body>

<!-- Calibration overlay -->
<div id="calibration-overlay">
  <h2>Eye Gaze Toggle Tracker</h2>
  <p>This demo uses your webcam to track how often you toggle your gaze between the <span style="color:var(--accent)">timer</span> (top right) and the <span style="color:var(--accent2)">reading text</span> (center). Click Start, allow camera access, then look around the screen. Click multiple spots to calibrate WebGazer.</p>
  <button id="start-btn">Start Tracking</button>
  <span id="status-msg">Camera permission required.</span>
</div>

<!-- Timer zone highlight -->
<div id="zone-timer"></div>
<!-- Text zone highlight -->
<div id="zone-text"></div>

<!-- Timer -->
<div id="timer-widget">
  <span id="timer-label">Elapsed</span>
  <span id="timer-display">00:00</span>
</div>

<!-- Main reading text -->
<div id="main-text">
  <h1>"The eye sees only what the mind is prepared to comprehend."</h1>
  <p>Robertson Davies wrote those words decades ago, but they resonate now more than ever. In an age of split attention — clocks, notifications, timers — we rarely dwell on a single idea. Read this text. Notice the pull of the timer. How often do you check it?</p>
</div>

<!-- Stats -->
<div id="stats">
  <div class="stat-card" id="stat-toggles">
    <div class="stat-val" id="val-toggles">0</div>
    <div class="stat-label">Gaze Toggles</div>
  </div>
  <div class="stat-card" id="stat-timer-looks">
    <div class="stat-val" id="val-timer-looks">0</div>
    <div class="stat-label">Timer Glances</div>
  </div>
  <div class="stat-card" id="stat-text-looks">
    <div class="stat-val" id="val-text-looks">0</div>
    <div class="stat-label">Text Looks</div>
  </div>
  <div class="stat-card" id="stat-current">
    <div class="stat-val" id="val-current">—</div>
    <div class="stat-label">Current Zone</div>
  </div>
</div>

<!-- Gaze dot -->
<div id="gaze-dot"></div>

<script>
(function() {
  const overlay = document.getElementById('calibration-overlay');
  const startBtn = document.getElementById('start-btn');
  const statusMsg = document.getElementById('status-msg');
  const gazeDot = document.getElementById('gaze-dot');
  const timerDisplay = document.getElementById('timer-display');
  const zoneTimer = document.getElementById('zone-timer');
  const zoneText  = document.getElementById('zone-text');

  const valToggles = document.getElementById('val-toggles');
  const valTimerLooks = document.getElementById('val-timer-looks');
  const valTextLooks  = document.getElementById('val-text-looks');
  const valCurrent    = document.getElementById('val-current');

  // ─── Timer ───────────────────────────────────────
  let startTime = null;
  function updateTimer() {
    if (!startTime) return;
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const m = String(Math.floor(elapsed / 60)).padStart(2, '0');
    const s = String(elapsed % 60).padStart(2, '0');
    timerDisplay.textContent = `${m}:${s}`;
  }

  // ─── Zone detection ───────────────────────────────
  // Returns 'timer' | 'text' | 'none' based on gaze position
  function getZone(x, y) {
    const tw = zoneTimer.getBoundingClientRect();
    const tx = zoneText.getBoundingClientRect();
    if (x >= tw.left && x <= tw.right && y >= tw.top && y <= tw.bottom) return 'timer';
    if (x >= tx.left && x <= tx.right && y >= tx.top && y <= tx.bottom) return 'text';
    return 'none';
  }

  // ─── State ───────────────────────────────────────
  let currentZone = 'none';
  let prevZone = 'none';
  let toggleCount = 0;
  let timerLooks = 0;
  let textLooks  = 0;

  // Smooth / debounce: require zone for N consecutive frames
  const FRAMES_THRESHOLD = 8;
  let candidateZone = 'none';
  let candidateFrames = 0;

  function onGaze(x, y) {
    if (!x || !y) return;

    gazeDot.style.left = x + 'px';
    gazeDot.style.top  = y + 'px';

    const zone = getZone(x, y);

    if (zone === candidateZone) {
      candidateFrames++;
    } else {
      candidateZone = zone;
      candidateFrames = 1;
    }

    if (candidateFrames >= FRAMES_THRESHOLD && zone !== currentZone) {
      const oldZone = currentZone;
      currentZone = zone;

      // Count entries
      if (zone === 'timer') timerLooks++;
      if (zone === 'text')  textLooks++;

      // Count toggle (timer ↔ text)
      if ((oldZone === 'timer' && zone === 'text') ||
          (oldZone === 'text'  && zone === 'timer')) {
        toggleCount++;
        const tv = valToggles;
        tv.textContent = toggleCount;
        tv.classList.remove('flash');
        void tv.offsetWidth; // reflow
        tv.classList.add('flash');
      }

      // Update zone highlights
      zoneTimer.classList.toggle('active', zone === 'timer');
      zoneText.classList.toggle('active',  zone === 'text');

      // Update counters
      valTimerLooks.textContent = timerLooks;
      valTextLooks.textContent  = textLooks;
      valCurrent.textContent = zone === 'timer' ? 'TIMER' : zone === 'text' ? 'TEXT' : '—';
    }
  }

  // ─── WebGazer init ────────────────────────────────
  startBtn.addEventListener('click', async () => {
    startBtn.disabled = true;
    statusMsg.textContent = 'Initializing camera…';

    try {
      webgazer.setGazeListener(function(data) {
        if (data == null) return;
        onGaze(data.x, data.y);
      });

      await webgazer
        .setRegression('ridge')
        .setTracker('TFFacemesh')
        .saveDataAcrossSessions(false)
        .begin();

      webgazer.showVideoPreview(true).showPredictionPoints(false);

      statusMsg.textContent = 'Click around the screen to calibrate, then start reading!';

      // Hide overlay after brief pause
      setTimeout(() => {
        overlay.style.transition = 'opacity 0.6s';
        overlay.style.opacity = '0';
        setTimeout(() => overlay.style.display = 'none', 600);
        gazeDot.style.display = 'block';
        startTime = Date.now();
        setInterval(updateTimer, 500);
      }, 1200);

    } catch (e) {
      statusMsg.textContent = 'Error: ' + e.message;
      startBtn.disabled = false;
    }
  });

  // Allow clicking on page to calibrate WebGazer
  document.addEventListener('click', (e) => {
    if (overlay.style.display === 'none' || overlay.style.opacity === '0') {
      // Calibration click — WebGazer picks this up automatically
    }
  });
})();
</script>
</body>
</html>

